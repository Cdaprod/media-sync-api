## Verification
# docker compose -f docker/docker-compose.yaml up -d
# docker compose -f docker/docker-compose.yaml ps
# docker compose -f docker/docker-compose.yaml exec resolve-postgres pg_isready -U ${RESOLVE_POSTGRES_USER:-resolve}

services:
  media-sync-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: media-sync-api
    restart: always

    ports:
      - "8787:8787"

    environment:
      - MEDIA_SYNC_HOST=0.0.0.0
      - MEDIA_SYNC_PORT=8787
      - MEDIA_SYNC_PROJECTS_ROOT=/data/projects
      - MEDIA_SYNC_SOURCES_PARENT_ROOT=/data/projects/_bridge
      - MEDIA_SYNC_MAX_UPLOAD_MB=4096
      - MEDIA_SYNC_CORS_ORIGINS=*
      - MEDIA_SYNC_BRIDGE_AGENT_URL=http://host.docker.internal:8790
      - MEDIA_SYNC_BRIDGE_ROOT_HOST=B:\\Video\\Projects\\_bridge
      - MEDIA_SYNC_AI_TAGGING_ENABLED=1
      - MEDIA_SYNC_AI_TAGGING_AUTO=1
      - MEDIA_SYNC_DEIM_URL=http://host.docker.internal:9001/tag
      - MEDIA_SYNC_WHISPERX_URL=http://host.docker.internal:9002/transcribe

    volumes:
      - "B:/Video/Projects:/data/projects"

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8787/health').read()"]
      interval: 20s
      timeout: 5s
      retries: 5

  resolve-postgres:
    image: postgres:15-alpine
    container_name: resolve-postgres
    restart: always
    command: ["postgres", "-c", "listen_addresses=*"]
    ports:
      - "0.0.0.0:5432:5432"
    environment:
      - POSTGRES_DB=${RESOLVE_POSTGRES_DB:-resolve_projects}
      - POSTGRES_USER=${RESOLVE_POSTGRES_USER:-resolve}
      - POSTGRES_PASSWORD=${RESOLVE_POSTGRES_PASSWORD:-resolve_change_me}
    volumes:
      - resolve_pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$${POSTGRES_USER}\" -d \"$${POSTGRES_DB}\""]
      interval: 10s
      timeout: 5s
      retries: 5
    # DaVinci Resolve Project Server (PostgreSQL library)
    # Connect Resolve to this host by adding a PostgreSQL library with:
    # Host: Docker host LAN IP (e.g., 192.168.0.25)
    # Port: 5432
    # Database: resolve_projects
    # User: resolve
    # Password: resolve_change_me (set RESOLVE_POSTGRES_PASSWORD to override)

volumes:
  resolve_pg_data:
